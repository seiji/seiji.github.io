<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Retrieving ECS-Optimized-AMI from ssm using terraform</title><meta name=description content><meta name=image content><meta itemprop=name content="Retrieving ECS-Optimized-AMI from ssm using terraform"><meta itemprop=description content><meta itemprop=image content><meta name=twitter:card content=summary><meta name=twitter:title content="Retrieving ECS-Optimized-AMI from ssm using terraform"><meta name=twitter:description content><meta name=twitter:site content=@><meta name=twitter:creator content=@><meta name=twitter:image:src content><meta name=og:title content="Retrieving ECS-Optimized-AMI from ssm using terraform"><meta name=og:description content><meta name=og:url content=http://seiji.github.io/post/2019-12-03-terraform-ami-from-ssm/><meta name=og:site_name content="Retrieving ECS-Optimized-AMI from ssm using terraform"><meta name=og:type content=article><meta name=article:author content><meta name=article:tag content=terraform><link rel=stylesheet type=text/css href=/css/base.css><script src=/js/caption.js></script></head><body><header><a href=/ style=float:left;color:#777><strong>posts</strong></a>
<a href=http://seiji.github.io/about/ style=color:#777;float:left><strong>About</strong></a>
<a href=/index.xml style=color:#777;float:left><strong>&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg></strong></a><div style=clear:both></div></header><div id=loadingMask style=width:100%;height:100%;position:fixed;background:#fff></div><script>function fadeOut(el){el.style.opacity=1;var last=+new Date();var tick=function(){el.style.opacity=+el.style.opacity-(new Date()-last)/80;last=+new Date();if(el.style.opacity>0){(window.requestAnimationFrame&&requestAnimationFrame(tick))||setTimeout(tick,16);}else{el.style.display='none';}};tick();}
function ready(fn){if(document.attachEvent?document.readyState==="complete":document.readyState!=="loading"){el=document.getElementById('loadingMask');fadeOut(el);var elements=document.querySelectorAll("img");Array.prototype.forEach.call(elements,function(el,i){if(el.getAttribute("alt")){const caption=document.createElement('figcaption');var node=document.createTextNode(el.getAttribute("alt"));caption.appendChild(node);const wrapper=document.createElement('figure');wrapper.className='image';el.parentNode.insertBefore(wrapper,el);el.parentNode.removeChild(el);wrapper.appendChild(el);wrapper.appendChild(caption);}});}else{document.addEventListener('DOMContentLoaded',fn);}}
window.onload=ready;</script><div class=content><h1>Retrieving ECS-Optimized-AMI from ssm using terraform<aside><a href=/tags/terraform/ class=w3-tag>/terraform</a>&nbsp;&nbsp;&nbsp;</aside></h1><p>We can use a datasource of <code>aws_ami</code> to retrieve image id.</p><p>Now AWS SSM Parameter Store allows for querying the latest Amazon Linux AMI.
Therefore I try more simpler way.</p><h2 id=terraform-versions>terraform versions</h2><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ terraform -v
Terraform v0.12.16
+ provider.aws v2.40.0</code></pre></div><h3 id=create-a-module>Create a module</h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:green;font-weight:700>data</span> <span style=color:green;font-weight:700>aws_ssm_parameter</span> <span style=color:green;font-weight:700>this</span> {
  name <span style=color:#666>=</span> <span style=color:#ba2121>&#34;/aws/service/ecs/optimized-ami/${join(&#34;/&#34;, compact([var.os, var.architecture]))}/recommended&#34;</span>
}

<span style=color:green;font-weight:700>variable</span> <span style=color:green;font-weight:700>os</span> {
  default <span style=color:#666>=</span> <span style=color:#ba2121>&#34;amazon-linux-2&#34;</span>
}

<span style=color:green;font-weight:700>variable</span> <span style=color:green;font-weight:700>architecture</span> {
  default <span style=color:#666>=</span> <span style=color:#ba2121>&#34;&#34;</span>
}

<span style=color:green;font-weight:700>output</span> <span style=color:green;font-weight:700>value</span> {
  value <span style=color:#666>=</span> <span style=color:green;font-weight:700>jsondecode</span>(<span style=color:green;font-weight:700>data</span>.<span style=color:green;font-weight:700>aws_ssm_parameter</span>.<span style=color:green;font-weight:700>this</span>.<span style=color:green;font-weight:700>value</span>)
}</code></pre></div><h3 id=using-the-module>Using the module</h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:green;font-weight:700>terraform</span> {
  required_version <span style=color:#666>=</span> <span style=color:#ba2121>&#34;~&gt; 0.12.0&#34;</span>
}

<span style=color:green;font-weight:700>provider</span> <span style=color:#ba2121>&#34;aws&#34;</span> {
  region <span style=color:#666>=</span> <span style=color:#ba2121>&#34;ap-northeast-1&#34;</span>
}

<span style=color:green;font-weight:700>module</span> <span style=color:green;font-weight:700>amazon_linux_2</span> {
  source <span style=color:#666>=</span> <span style=color:#ba2121>&#34;../&#34;</span>
}

<span style=color:green;font-weight:700>output</span> <span style=color:green;font-weight:700>amazon_linux_2</span> {
  value <span style=color:#666>=</span> <span style=color:green;font-weight:700>module</span>.<span style=color:green;font-weight:700>amazon_linux_2</span>.<span style=color:green;font-weight:700>value</span>
}</code></pre></div><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Outputs:

<span style=color:#19177c>amazon_linux_2</span> <span style=color:#666>=</span> <span style=color:#666>{</span>
  <span style=color:#ba2121>&#34;ecs_agent_version&#34;</span> <span style=color:#666>=</span> <span style=color:#ba2121>&#34;1.33.0&#34;</span>
  <span style=color:#ba2121>&#34;ecs_runtime_version&#34;</span> <span style=color:#666>=</span> <span style=color:#ba2121>&#34;Docker version 18.06.1-ce&#34;</span>
  <span style=color:#ba2121>&#34;image_id&#34;</span> <span style=color:#666>=</span> <span style=color:#ba2121>&#34;ami-0934e28fe3e390537&#34;</span>
  <span style=color:#ba2121>&#34;image_name&#34;</span> <span style=color:#666>=</span> <span style=color:#ba2121>&#34;amzn2-ami-ecs-hvm-2.0.20191114-x86_64-ebs&#34;</span>
  <span style=color:#ba2121>&#34;os&#34;</span> <span style=color:#666>=</span> <span style=color:#ba2121>&#34;Amazon Linux 2&#34;</span>
  <span style=color:#ba2121>&#34;schema_version&#34;</span> <span style=color:#666>=</span> <span style=color:#666>1</span>
<span style=color:#666>}</span></code></pre></div><p><a href=https://github.com/seiji/terraform-aws-ecs-ami>https://github.com/seiji/terraform-aws-ecs-ami</a></p><ul><li><a href=https://aws.amazon.com/jp/blogs/compute/query-for-the-latest-amazon-linux-ami-ids-using-aws-systems-manager-parameter-store/>Query for the latest Amazon Linux AMI IDs using AWS Systems Manager Parameter Store</a></li><li><a href=https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-ami-versions.html>Amazon ECS-optimized AMI Versions - Amazon Elastic Container Service</a></li><li><a href=https://docs.aws.amazon.com/AmazonECS/latest/developerguide/retrieve-ecs-optimized_AMI.html>Retrieving Amazon ECS-Optimized AMI Metadata - Amazon Elastic Container Service</a></li></ul></div><p><small><em>Written December 3, 2019.</em></small></p><p><a href=/post/2019-12-01-terraform-mv-items-in-state/>‚Üê Move multiple items in terraform states</a>&nbsp;</p><footer></footer></body></html>