<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Move multiple items in terraform states</title><meta name=description content><meta name=image content><meta itemprop=name content="Move multiple items in terraform states"><meta itemprop=description content><meta itemprop=image content><meta name=twitter:card content=summary><meta name=twitter:title content="Move multiple items in terraform states"><meta name=twitter:description content><meta name=twitter:site content=@><meta name=twitter:creator content=@><meta name=twitter:image:src content><meta name=og:title content="Move multiple items in terraform states"><meta name=og:description content><meta name=og:url content=http://seiji.github.io/post/2019-12-01-terraform-mv-items-in-state/><meta name=og:site_name content="Move multiple items in terraform states"><meta name=og:type content=article><meta name=article:author content><meta name=article:tag content=terraform><link rel=stylesheet type=text/css href=/css/base.css><script src=/js/caption.js></script></head><body><header><a href=/ style=float:left;color:#777><strong>posts</strong></a>
<a href=http://seiji.github.io/about/ style=color:#777;float:left><strong>About</strong></a>
<a href=/index.xml style=color:#777;float:left><strong>&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg></strong></a><div style=clear:both></div></header><div id=loadingMask style=width:100%;height:100%;position:fixed;background:#fff></div><script>function fadeOut(el){el.style.opacity=1;var last=+new Date();var tick=function(){el.style.opacity=+el.style.opacity-(new Date()-last)/80;last=+new Date();if(el.style.opacity>0){(window.requestAnimationFrame&&requestAnimationFrame(tick))||setTimeout(tick,16);}else{el.style.display='none';}};tick();}
function ready(fn){if(document.attachEvent?document.readyState==="complete":document.readyState!=="loading"){el=document.getElementById('loadingMask');fadeOut(el);var elements=document.querySelectorAll("img");Array.prototype.forEach.call(elements,function(el,i){if(el.getAttribute("alt")){const caption=document.createElement('figcaption');var node=document.createTextNode(el.getAttribute("alt"));caption.appendChild(node);const wrapper=document.createElement('figure');wrapper.className='image';el.parentNode.insertBefore(wrapper,el);el.parentNode.removeChild(el);wrapper.appendChild(el);wrapper.appendChild(caption);}});}else{document.addEventListener('DOMContentLoaded',fn);}}
window.onload=ready;</script><div class=content><h1>Move multiple items in terraform states<aside><a href=/tags/terraform/ class=w3-tag>/terraform</a>&nbsp;&nbsp;&nbsp;</aside></h1><p>Some of <code>terraform state</code> commands can be used in case that modify the terraform state.</p><p>We use <code>terraform state mv</code> command to move items or rename items in that state, enabling efficient refactoring.</p><h3 id=terraform-versions>terraform versions</h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ terraform -v
Terraform v0.12.16
+ provider.aws v2.40.0</code></pre></div><h3 id=all-resources-within-a-terraform-state>All resources within a terraform state.</h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ terraform state list
module.cloud_trails.data.aws_caller_identity.this
module.cloud_trails.aws_cloudtrail.this
module.cloud_trails.aws_s3_bucket.this
module.cloud_trails.aws_s3_bucket_policy.this
module.guard_duty.aws_guardduty_detector.this</code></pre></div><h3 id=example-rename-module-cloud-trails-to-module-cloudtrail>Example: Rename <code>module.cloud_trails.*</code> to <code>module.cloudtrail.*</code></h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ terraform state mv -dry-run <span style=color:#ba2121>&#39;module.cloud_trails&#39;</span> <span style=color:#ba2121>&#39;module.cloudtrail&#39;</span>
Would move <span style=color:#ba2121>&#34;module.cloud_trails&#34;</span> to <span style=color:#ba2121>&#34;module.cloudtrail&#34;</span></code></pre></div><h3 id=example-rename-module-cloud-trails-this-to-module-cloud-trails-that>Example: Rename <code>module.cloud_trails.*.this</code> to <code>module.cloud_trails.*.that</code></h3><div class=highlight><pre style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ terraform state list module.cloud_trails
| awk <span style=color:#ba2121>&#39;{print $1 &#34; &#34; $1}&#39;</span> <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>| sed <span style=color:#ba2121>&#39;s/this/that/2&#39;</span> <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>| xargs -n2 bash -c <span style=color:#ba2121>&#39;terraform state mv -dry-run $0 $1&#39;</span>
Would move <span style=color:#ba2121>&#34;module.cloud_trails.data.aws_caller_identity.this&#34;</span> to <span style=color:#ba2121>&#34;module.cloud_trails.data.aws_caller_identity.that&#34;</span>
Would move <span style=color:#ba2121>&#34;module.cloud_trails.aws_cloudtrail.this&#34;</span> to <span style=color:#ba2121>&#34;module.cloud_trails.aws_cloudtrail.that&#34;</span>
Would move <span style=color:#ba2121>&#34;module.cloud_trails.aws_s3_bucket.this&#34;</span> to <span style=color:#ba2121>&#34;module.cloud_trails.aws_s3_bucket.that&#34;</span>
Would move <span style=color:#ba2121>&#34;module.cloud_trails.aws_s3_bucket_policy.this&#34;</span> to <span style=color:#ba2121>&#34;module.cloud_trails.aws_s3_bucket_policy.that&#34;</span></code></pre></div><p>You need to eliminate <code>-dry-run</code> to rename itemes in the state.</p><ul><li><a href=https://www.terraform.io/docs/commands/state/index.html>Command: state - Terraform by HashiCorp</a></li><li><a href=https://www.terraform.io/docs/commands/state/mv.html>Command: state mv - Terraform by HashiCorp</a></li></ul></div><p><small><em>Written December 1, 2019.</em></small></p><p><a href=/post/2019-12-03-terraform-ami-from-ssm/ style=float:right>Retrieving ECS-Optimized-AMI from ssm using terraform â†’</a></p><footer></footer></body></html>